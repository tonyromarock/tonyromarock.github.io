<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>A Place for Asides - Linux</title><link href="https://tonyromarock.github.io/" rel="alternate"></link><link href="https://tonyromarock.github.io/feeds/linux.atom.xml" rel="self"></link><id>https://tonyromarock.github.io/</id><updated>2019-11-05T17:55:00+01:00</updated><entry><title>Using the Infrared Camera of the Dell XPS on Ubuntu 18.04</title><link href="https://tonyromarock.github.io/blog/dell-xps-ir-camera.html" rel="alternate"></link><published>2019-11-05T17:55:00+01:00</published><updated>2019-11-05T17:55:00+01:00</updated><author><name>Peter Mortimer</name></author><id>tag:tonyromarock.github.io,2019-11-05:/blog/dell-xps-ir-camera.html</id><summary type="html">&lt;p&gt;Accessing the infrared camera of the Dell XPS 13 9370.&lt;/p&gt;</summary><content type="html">&lt;p&gt;I was interested in using the unusual webcam setup of my Dell XPS 13 9370 notebook for some personal projects. The Dell XPS 13 9370 does not only have a regular color camera but also an infrared camera. On Windows the infrared camera and the color camera are used for Windows Hello, which allows the user to secure his PC using facial authentication (&lt;a href="https://github.com/boltgolt/howdy"&gt;Howdy&lt;/a&gt; is the closest equivalent for Linux). But when I tried to access my infrared camera using tools like &lt;code&gt;fswebcam&lt;/code&gt; or installing Howdy I ran into several issues.&lt;/p&gt;
&lt;p&gt;It turns out that the infrared camera of the Dell XPS 13 9370 uses an unusual 8-bit infrared video format called L8_IR (&lt;a href="https://github.com/boltgolt/howdy/issues/88#issuecomment-457708769"&gt;see this GitHub Issue for Howdy&lt;/a&gt;). This format is currently not supported by the driver in Ubuntu 18.04, but it was added to the linux kernel 4.19 (&lt;a href="https://github.com/torvalds/linux/commit/557a5c7fe6503230f6a3a41441981aed6e897d17"&gt;see the commit here&lt;/a&gt;) and that kernel version is expected to then be available on Ubuntu 19.04. That's good to know, but I still wanted to find a way to make use of the infrared camera on Ubuntu 18.04. &lt;/p&gt;
&lt;p&gt;Following an approach similar to &lt;a href="https://stackoverflow.com/questions/25799264/characterizing-my-raw-camera-output"&gt;NSchrading on Stack Overflow&lt;/a&gt; I tried to make sense of the raw data produced by the infrared camera using the following &lt;code&gt;fswebcam&lt;/code&gt; command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libv4l/v4l1compat.so fswebcam --palette GREY --device RAW:/dev/video1 --no-banner --no-timestamp --resolution &amp;quot;340x340&amp;quot; --dumpframe ir.raw
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The command contains many optional arguments, so I will briefly break down what the individual arguments do: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;LD_PRELOAD&lt;/code&gt; provides the absolute path to the Video4Linux library on my system, which has to be &lt;a href="https://stackoverflow.com/questions/426230/what-is-the-ld-preload-trick"&gt;preloaded&lt;/a&gt; for &lt;code&gt;fswebcam&lt;/code&gt; to correctly read from the raw video source of the infrared camera. You might have to change this path if Video4Linux is stored somewhere else on your system (&lt;a href="https://www.raspberrypi.org/forums/viewtopic.php?t=86265#post_content859415"&gt;see this comment on how to find the v4l1compat.so&lt;/a&gt;). &lt;/li&gt;
&lt;li&gt;&lt;code&gt;--palette GREY&lt;/code&gt; is the closest palette format supported by &lt;code&gt;fswebcam&lt;/code&gt; to L8_IR. &lt;/li&gt;
&lt;li&gt;&lt;code&gt;--device RAW:/dev/video1&lt;/code&gt; specifies that we are reading the raw video data provided by the infrared camera, the color camera is found at &lt;code&gt;/dev/video0&lt;/code&gt;. &lt;/li&gt;
&lt;li&gt;&lt;code&gt;--no-banner --no-timestamp&lt;/code&gt; remove the default banner added by &lt;code&gt;fswebcam&lt;/code&gt;. &lt;/li&gt;
&lt;li&gt;&lt;code&gt;--resolution "340x340"&lt;/code&gt; defines the image resolution of the infrared camera, which is specified &lt;a href="https://topics-cdn.dell.com/pdf/xps-13-9370-laptop_setup-guide_en-us.pdf"&gt;here&lt;/a&gt; by Dell. &lt;/li&gt;
&lt;li&gt;&lt;code&gt;--dumpframe&lt;/code&gt; specifies that we want to dump the raw frame to a file.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So running this command gives us an &lt;code&gt;ir.raw&lt;/code&gt; file. You can also notice that the infrared emitters light up red when taking an infrared image.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Both infrared emitters light up red when taking an image with the infrared camera." src="https://tonyromarock.github.io/images/ir_camera/ir_camera_crop.gif"&gt;&lt;/p&gt;
&lt;p&gt;Most programs cannot view .raw files, for this I wrote a quick script to validate if we are actually downloading a valid 8-bit infrared image. This &lt;a href="https://lwn.net/Articles/218798/"&gt;blog post&lt;/a&gt; by a Linux driver developer for camera devices explains very well how the different color formats for Video4Linux2 are defined using the &lt;a href="https://www.fourcc.org/fourcc.php"&gt;fourcc&lt;/a&gt; coding mechanism. The fornat for our 8-bit infrared format is &lt;code&gt;V4L_PIX_FMT_GREY&lt;/code&gt;. So one byte describes the grayscale value for the given pixel. With this knowledge and knowing the output resolution of the infrared camera, we can write the following script to display the infrared image using matplotlib:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;matplotlib.pyplot&lt;/span&gt; &lt;span class="kn"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;plt&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;numpy&lt;/span&gt; &lt;span class="kn"&gt;as&lt;/span&gt; &lt;span class="nn"&gt;np&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;matplotlib&lt;/span&gt; &lt;span class="n"&gt;inline&lt;/span&gt;

&lt;span class="n"&gt;grays&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;np&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="kp"&gt;zeros&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="mi"&gt;340&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;340&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="kp"&gt;dtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ir.raw&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;r+b&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;340&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;j&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;340&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;val&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;pixel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;from_bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;val&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;byteorder&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;big&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;grays&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;j&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pixel&lt;/span&gt;

&lt;span class="n"&gt;plt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imshow&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;grays&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;cmap&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gray&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here is an example image produced by my infrared camera:&lt;/p&gt;
&lt;p&gt;&lt;img alt="An example image produced by the infrared camera." src="https://tonyromarock.github.io/images/ir_camera/ir_face.png"&gt;&lt;/p&gt;
&lt;p&gt;So it took quite a bit to get to this point, but now we have the tools to implement some interesting Computer Vision applications using the stereo image setup of the Dell XPS 13 9370. I hope this is useful for other Dell users trying to get started with the built-in infrared camera.&lt;/p&gt;</content><category term="fswebcam"></category><category term="image processing"></category></entry></feed>